name: 'Terraform'
run-name: ${{ github.actor }} is deploying...

on:
  workflow_dispatch:
  # push:
  #   branches:
  #   - main
  # pull_request:
  #   branches:
  #   - main

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform validation'
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials For GitHub Actions
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRECT_KEY }}
          aws-region: ap-southeast-2 

      - name: HashiCorp-Setup Terraform CLI
        uses: hashicorp/setup-terraform@v2.0.3

      - name: zip files for lambda function
        run: |
          zip -j lambda_code_s3tosagemaker.zip ../dataserving/de-ers_s3tosagemaker.py
          zip -j lambda_function_get_recommendation.zip ../dataserving/de-ers_API.py

      - name: Terraform fmt
        run: terraform fmt
        working-directory: ./terraform

      - name: Terraform init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform plan
        if: github.event_name == 'pull_request'
        run: terraform plan
        working-directory: ./terraform


      - name: Terraform apply
        if: github.event_name == 'push'
        run: terraform apply -auto-approve
        working-directory: ./terraform